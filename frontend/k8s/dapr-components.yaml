---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dapr-components
  namespace: realtime-platform
  labels:
    app: realtime-frontend
    component: dapr
data:
  pubsub.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Component
    metadata:
      name: mastery-pubsub
      namespace: realtime-platform
    spec:
      type: pubsub.redis
      version: v1
      metadata:
      - name: redisHost
        value: redis-service.realtime-platform.svc.cluster.local:6379
      - name: redisPassword
        secretKeyRef:
          name: realtime-secrets
          key: redis-password
      - name: consumerID
        value: "realtime-frontend"
      - name: enableTLS
        value: "false"
      - name: concurrency
        value: "10"
    scopes:
      - realtime-frontend
      - mastery-engine
      - analytics-service

  statestore.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Component
    metadata:
      name: statestore
      namespace: realtime-platform
    spec:
      type: state.redis
      version: v1
      metadata:
      - name: redisHost
        value: redis-service.realtime-platform.svc.cluster.local:6379
      - name: redisPassword
        secretKeyRef:
          name: realtime-secrets
          key: redis-password
      - name: ttlInSeconds
        value: "3600"
      - name: maxRetries
        value: "3"
      - name: failover
        value: "false"

  secretstore.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Component
    metadata:
      name: kubernetes-secret-store
      namespace: realtime-platform
    spec:
      type: secretstores.kubernetes
      version: v1
      metadata:
      - name: enabled
        value: "true"

  zipcode-pubsub.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Component
    metadata:
      name: zipcode-pubsub
      namespace: realtime-platform
    spec:
      type: pubsub.redis
      version: v1
      metadata:
      - name: redisHost
        value: redis-service.realtime-platform.svc.cluster.local:6379
      - name: consumerID
        value: "realtime-frontend"

  # Subscriptions configuration for the frontend
  subscriptions.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Subscription
    metadata:
      name: realtime-frontend-subscriptions
      namespace: realtime-platform
    spec:
      topic: mastery-updates
      route: /api/events/mastery
      pubsubname: mastery-pubsub
      delivery: at-least-once
      scopes:
        - realtime-frontend

  # Configuration for pub/sub behavior
  configuration.yaml: |
    apiVersion: dapr.io/v1alpha1
    kind: Configuration
    metadata:
      name: dapr-config
      namespace: realtime-platform
    spec:
      tracing:
        samplingRate: "1"
        zipkin:
          endpointAddress: "http://zipkin:9411/api/v2/spans"
      logging:
        level: info
      metrics:
        enabled: true
      secrets:
        scopes:
          - storeName: kubernetes-secret-store
            defaultAccess: allow
            deniedSecrets:
              - "redis-password"
      middleware:
        httpPipeline:
          components:
            - name: secrets.kubernetes
              type: middleware.http.secretstore
              version: v1
      app:
        maxConcurrency: 10
        qos: balanced
        recoverPanic: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dapr-frontend-subscriptions
  namespace: realtime-platform
  labels:
    app: realtime-frontend
    component: dapr
data:
  # Subscriptions defined for the frontend microservice
  subscriptions.json: |
    {
      "pubsubName": "mastery-pubsub",
      "topic": "mastery-updated",
      "route": "/api/events/mastery-updated",
      "metadata": {
        "rawPayload": "false",
        "priority": "high"
      }
    },
    {
      "pubsubName": "mastery-pubsub",
      "topic": "feedback-received",
      "route": "/api/events/feedback",
      "metadata": {
        "rawPayload": "false",
        "priority": "normal"
      }
    },
    {
      "pubsubName": "mastery-pubsub",
      "topic": "learning-recommendation",
      "route": "/api/events/recommendation",
      "metadata": {
        "rawPayload": "false",
        "priority": "low"
      }
    },
    {
      "pubsubName": "mastery-pubsub",
      "topic": "progress-submitted",
      "route": "/api/events/progress",
      "metadata": {
        "rawPayload": "false",
        "priority": "normal"
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-service
  namespace: realtime-platform
  labels:
    app: redis
    component: cache
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
              name: redis
          command:
            - redis-server
            - "--requirepass"
            - "$(REDIS_PASSWORD)"
            - "--appendonly"
            - "yes"
            - "--maxmemory"
            - "256mb"
            - "--maxmemory-policy"
            - "allkeys-lru"
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: realtime-secrets
                  key: redis-password
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          volumeMounts:
            - name: redis-data
              mountPath: /data
      volumes:
        - name: redis-data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: redis-service
  namespace: realtime-platform
  labels:
    app: redis
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
      name: redis
  selector:
    app: redis